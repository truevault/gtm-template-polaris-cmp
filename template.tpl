___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "TrueVault Polaris CMP",
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "TrueVault",
    "displayName": "TrueVault",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "TrueVault Polaris is an all-in-one compliance software designed for SMBs. More at \u003ca href\u003d\"https://www.truevault.com\"\u003ewww.truevault.com\u003c/a\u003e",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "consentDefaults",
    "displayName": "Consent Defaults",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "adStorage",
        "checkboxText": "Ad Storage",
        "simpleValueType": true,
        "help": "Allow advertising cookies before visitor gives consent."
      },
      {
        "type": "CHECKBOX",
        "name": "analyticsStorage",
        "checkboxText": "Analytics Storage",
        "simpleValueType": true,
        "help": "Allow analytics cookies before visitor gives consent."
      },
      {
        "type": "CHECKBOX",
        "name": "functionalityStorage",
        "checkboxText": "Functionality Storage",
        "simpleValueType": true,
        "help": "Allow website functionality cookies before visitor gives consent.",
        "defaultValue": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "personalizationStorage",
        "checkboxText": "Personalization Storage",
        "simpleValueType": true,
        "help": "Allow personalization cookies before visitor gives consent."
      }
    ],
    "help": "Consent defaults for the visitor before they interact with the Cookie Consent Settings banner or modal."
  },
  {
    "type": "CHECKBOX",
    "name": "adsDataRedaction",
    "checkboxText": "Redact Ads Data",
    "simpleValueType": true,
    "help": "Further redact your ad's data when Ad Storage is denied."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

//
// This is a template for Google Tag Manager, and is based heavily
// on the example template from CMP documentation found here:
// https://developers.google.com/tag-platform/tag-manager/templates/consent-apis#use_the_template_editor_to_create_the_template
//
// This template is modified to match the integration build in `gtm.ts`
// for the Polaris snippet
//

// Example Data expected from the GTM UI
//
// data = {
// "adsDataRedaction":false,
// "personalizationStorage":false,
// "analyticsStorage":false,
// "adStorage":false,
// "functionalityStorage":false,
// "gtmTagId":2147483646,
// "gtmEventId":3
// }
//

const COOKIE_NAME = "polaris_consent_settings";

const JSON = require("JSON");

// Uncomment if you wish to add logging to this code
// const log = require("logToConsole");
const setDefaultConsentState = require("setDefaultConsentState");
const updateConsentState = require("updateConsentState");
const getCookieValues = require("getCookieValues");
const callInWindow = require("callInWindow");
const gtagSet = require("gtagSet");

const CONSENT_DEFAULT_OFF_COUNTRY_CODES = [
  "AT",
  "BE",
  "BG",
  "CY",
  "CZ",
  "DE",
  "DK",
  "EE",
  "ES",
  "FI",
  "FR",
  "GB",
  "GR",
  "HR",
  "HU",
  "IE",
  "IS",
  "IT",
  "LI",
  "LT",
  "LU",
  "LV",
  "MT",
  "NL",
  "NO",
  "PL",
  "PT",
  "RO",
  "SE",
  "SI",
  "SK",
  "UK",
  "CH",
  "CA-QC"
];


// Transform an object of booleans into an object
// of granted/denied strings for sending to GTM
const parseConsent = (consent) => {
  return {
    ad_storage: consent.adConsentGranted ? "granted" : "denied",
    analytics_storage: consent.analyticsConsentGranted ? "granted" : "denied",
    functionality_storage: consent.functionalityConsentGranted ? "granted" : "denied",
    personalization_storage: consent.personalizationConsentGranted ? "granted" : "denied",
    security_storage: consent.securityConsentGranted ? "granted" : "denied",
    ad_user_data: consent.adConsentGranted ? "granted" : "denied",
    ad_personalization: consent.adConsentGranted ? "granted" : "denied",
    tv_not_opted_out: consent.notOptedOut ? "granted" : "denied",
  };
};

// Registered as a Callback on the client page, this function
// is expected to be called by the Polaris Cookie Consent Banner
// any time the user consent is updated.
const onUserConsent = (consent) => {
  updateConsentState(parseConsent(consent));
};

const parseConsentDefaults = (data) => {
  return parseConsent({
    analyticsConsentGranted: data.analyticsStorage,
    adConsentGranted: data.adStorage,
    personalizationConsentGranted: data.personalizationStorage,
    securityConsentGranted: data.functionalityStorage,
    functionalityConsentGranted: data.functionalityStorage,
    tv_not_opted_out: true, /* There is no GTM Template toggle we expose for this concept, it would be confusing - and toggling off only applies to USP regions anyway. */
  });
};

const formatConsentCookie = (cookie) => {
  if (!cookie) {
    return null;
  }

  const parsedCookie = JSON.parse(cookie);

  return {
    analyticsConsentGranted: parsedCookie.analyticsPermitted,
    adConsentGranted: parsedCookie.adsPermitted,
    personalizationConsentGranted: parsedCookie.personalizationPermitted,
    securityConsentGranted: parsedCookie.essentialPermitted,
    functionalityConsentGranted: parsedCookie.essentialPermitted,
    notOptedOut: parsedCookie.notOptedOut !== false, /* This can be undefined if the cookie isn't set. Undefined -> true, we haven't opted out */
  };
};

/**
 * Executes the default command, sets the developer ID, and sets up the consent
 * update callback
 */
const main = (data) => {
  // Set developer ID
  // gtagSet('developer_id.<replace_with_your_developer_id>', true);

  // Set default consent required state(s)
  let defaultData = parseConsentDefaults(data);
  defaultData.wait_for_update = 500;
  defaultData.region = CONSENT_DEFAULT_OFF_COUNTRY_CODES;

  setDefaultConsentState(defaultData);

  // Set implicit defaults everywhere else
  setDefaultConsentState({
    ad_storage: 'granted',
    analytics_storage: 'granted',
    functionality_storage: 'granted',
    personalization_storage: 'granted',
    security_storage: 'granted',
    ad_user_data: 'granted',
    ad_personalization: 'granted',
    tv_not_opted_out: 'granted',
    wait_for_update: 500,
  });

  // Set data redaction value
  gtagSet('adsDataRedaction', data.adsDataRedaction);

  // Check if the Polaris Cookie is set, and if it is,
  // run user consent with those values.
  const settingsCookies = getCookieValues(COOKIE_NAME);
  if (typeof settingsCookies !== "undefined") {
    const consent = formatConsentCookie(settingsCookies[0]);

    if (consent) {
      onUserConsent(consent);
    }
  }

  // Add an event listener so that Polaris can communicate
  // when Consent settings change
  callInWindow("addConsentListener", onUserConsent);
};

main(data);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "addConsentListener"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "adsDataRedaction"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "polaris_consent_settings"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "tv_not_opted_out"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Implicit consent by default (since we can't mock region)
  code: "const isConsentGranted = require('isConsentGranted');\n\nconst mockData =\
    \ {\n  // Mocked field values\n  analyticsStorage: true,\n  adStorage: true,\n\
    \  personalizationStorage: true,\n  functionalityStorage: true,\n};  \n\n// Call\
    \ runCode to run the template's code.\nrunCode(mockData);\n\nassertThat(isConsentGranted('ad_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('ad_user_data')).isEqualTo(true);\nassertThat(isConsentGranted('ad_personalization')).isEqualTo(true);\n\
    assertThat(isConsentGranted('personalization_storage')).isEqualTo(true);\nassertThat(isConsentGranted('analytics_storage')).isEqualTo(true);\n\
    assertThat(isConsentGranted('functionality_storage')).isEqualTo(true);\nassertThat(isConsentGranted('security_storage')).isEqualTo(true);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"


___NOTES___

Created on 9/23/2021, 11:22:06 AM


